<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>보낸 메일함</title>
    <!--폰트 어썸 (아이콘 사용)-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!--부트스트랩5버전: 버튼과 모달창에 사용-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/script/jquery-3.7.1.min.js}"></script>
    <script>
        $(function () {
            init(); // 보낸 메일 전체 출력 

        });
        function init() {
            let userNum = $("#userNum").val();// 로그인한 사람의 고유번호(시퀀스)

            $.ajax({
                url: "/mail/mailList"
                , method: 'GET'
                , data: { "userNum": userNum }
                , success: output
            })
        }// init-end

        function output(item) {
            let receivedData = `
                    <tr>
                        <th>받는사람</th>
                        <th>제목</th>
                        <th>보낸 날짜</th>
                        <th>삭제</th>
                        
                    </tr>`;
            $.each(item, function (index, item) {

                receivedData += `
                        <tr>
                            <input type="hidden" name="userNum" value=${item.emailContent}><!--메일 내용 -->
                            <td>${item.receiver}</td>
                            <td>
                                <a data-bs-target="#myModal" data-bs-toggle="modal" href="#" class="emailModal" 
                                attr-emailNum=${item.emailNum}>${item.emailSubject}
                                    </a>
                            </td>
                            <td>${item.sendedDate}</td>
                            <td><i type="button" class="fa-regular fa-trash-can deleteBtn" attr-emailNum=${item.emailNum}></i></td>
                            `
                    // <td><a href="#"><i type="button" class="fa-regular fa-trash-can"></i></a></td>

                    ;
                receivedData += `</tr>`;
            });//each

            $("#sendedEmail-list").html(receivedData);

            //이메일 세부사항 모당창에 내용 집어 넣는 부분 - ajax로 넘어갔다오기 
            $(".emailModal").on('click', mailDetails);
            $(".deleteBtn").on('click', deleteMail);
            function mailDetails() {
                //ajax

                let emailNum = $(this).attr("attr-emailNum");


                $.ajax({
                    url: "/mail/mailSelectOne"
                    , method: 'GET'
                    , data: { "emailNum": emailNum }
                    , success: function (item) {
                        //alert(item)

                        $("#receiver").val(item.receiver);
                        $("#sendedDate").val(item.sendedDate);
                        $("#emailSubject").val(item.emailSubject);
                        $("#emailContent").val(item.emailContent);

                    }
                })// ajax-end

            }//mailDetails-end

            // 이메일 삭제 함수 
            function deleteMail() {
                let emailNum = $(this).attr("attr-emailNum");
                if (confirm("해당 메일을 삭제하시겠습니까?")) {

                    $.ajax({
                        url: "/mail/mailDelete"
                        , method: 'GET'
                        , data: { "emailNum": emailNum }
                        , success: function (item) {
                        }
                    })// ajax-end

                }
                let data = $(this).parent().parent();// 화면에서 tr객체 삭제 
                data.remove();
                //$("#board-count").html(favCount);


            }

        }// 전체 output 출력 부분 


    </script>

</head>

<body>
    <h2>보낸 메일함</h2>
    <!-- 로그인 유저의 고유 넘버값 넣어주는거 있지말기-->
    <!-- <input type="hidden" id="loginId" th:value="${#authentication.name}"> 로그인한 유저의 -->
    <input type="hidden" id="userNum" value="1"><!--우선은 임으로 만들어봄 -->
    <span id="noResult"></span><!--보낸 메일함이 적을때 출력합니다.
    -->
    <table id="sendedEmail-list"> <!--보낸 편지 출력-->
    </table>

    <!--보낸편지 모달창으로 띄우기-->
    <!-- 이메일 모달창 부분 -->
    <div class="modal" id="myModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">보낸 메일</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <!-- Modal body: 받느사람 제목등 수정삽입 필요 -->
                <div class="modal-body">
                    <input id="receiver" class="form-control" value="" readonly>
                    <br>
                    <input id="sendedDate" class="form-control" readonly> <br>
                    <input id="emailSubject" class="form-control" readonly> <br>
                    <textarea id="emailContent" cols="60" rows="20" class="form-control" readonly></textarea>
                </div>


                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                </div>
                </form>

            </div>
        </div>
    </div> <!--이메일 모달창 끝-->


</body>

</html>